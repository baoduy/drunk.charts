# drunk.charts Repository - Copilot Instructions

## Repository Overview
This repository contains Helm charts for deploying applications to Kubernetes. It follows a modular approach with shared libraries and comprehensive testing using the helm-unittest plugin.

## Repository Structure

### Charts
- **drunk-app**: Main application chart with full Kubernetes deployment capabilities
  - Location: `./drunk-app/`
  - Depends on: `drunk-lib`
  - Features: Deployment, Service, Ingress, Jobs, CronJobs, HPA, Secrets, ConfigMaps
- **drunk-lib**: Shared library chart with common templates and helpers
  - Location: `./drunk-lib/`
  - Type: Library chart (provides reusable templates)
- **drunk-squid-basic-auth**: Squid proxy chart with basic authentication
  - Location: `./drunk-squid-basic-auth/`
- **cert-generator**: Certificate generation utilities
  - Location: `./cert-generator/`

### Key Files in Each Chart
```
chart-name/
├── Chart.yaml          # Chart metadata and dependencies
├── values.yaml         # Default configuration values
├── values.test.yaml    # Test-specific values (for drunk-app)
├── templates/          # Kubernetes YAML templates
├── tests/             # helm-unittest test files (*.test.yaml)
├── charts/            # Downloaded dependencies
├── build.sh           # Dependency management script
├── test.sh            # Unit test execution script
├── verify.sh          # Chart verification and packaging script
└── README.md          # Chart-specific documentation
```

## Testing Framework - helm-unittest

### Overview
All charts use the [helm-unittest](https://github.com/helm-unittest/helm-unittest) plugin for unit testing. This plugin allows testing Helm chart templates without deploying to a Kubernetes cluster.

### Installing helm-unittest
```bash
helm plugin install https://github.com/helm-unittest/helm-unittest.git
```

### Test File Structure
Test files are located in `tests/` directories with `.test.yaml` extension:
- `deployment.test.yaml` - Tests for Deployment templates
- `service.test.yaml` - Tests for Service templates
- `ingress.test.yaml` - Tests for Ingress templates
- `configMap.test.yaml` - Tests for ConfigMap templates
- etc.

### Test File Format
```yaml
suites: Template Test Suite Name
templates:
  - template-name.yaml
tests:
  - it: should test specific behavior
    set:
      # Values to set for this test
      key: value
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: expected-name
```

### Common Test Assertions
- `hasDocuments: {count: N}` - Verify number of documents rendered
- `isKind: {of: ResourceType}` - Verify Kubernetes resource type
- `equal: {path: yaml.path, value: expected}` - Verify specific values
- `isSubset: {path: yaml.path, content: {}}` - Verify subset of values
- `isNotEmpty: {path: yaml.path}` - Verify path exists and has content
- `isNull: {path: yaml.path}` - Verify path is null or doesn't exist
- `contains: {path: array.path, content: {}}` - Verify array contains item
- `notContains: {path: array.path, content: {}}` - Verify array doesn't contain item

### Running Tests
```bash
# Run all tests in a chart
cd chart-directory
helm unittest -f 'tests/*.yaml' ./

# Run specific test file
helm unittest -f 'tests/deployment.test.yaml' ./
```

## Development Workflow

### Working with Charts

#### 1. Chart Dependencies
```bash
# Update and build dependencies (run from chart directory)
./build.sh
# or manually:
helm dependency update
helm dependency build
```

#### 2. Testing Charts
```bash
# Run unit tests
./test.sh
# or manually:
helm unittest -f 'tests/*.yaml' ./
```

#### 3. Verifying Charts
```bash
# Verify, lint, and package chart
./verify.sh
# This typically includes:
# - helm template (dry-run rendering)
# - helm lint (chart validation)
# - helm package (create .tgz)
# - helm repo index (update index.yaml)
```

### Chart Development Best Practices

#### Template Development
- Use library chart templates from `drunk-lib` when possible
- Follow Kubernetes naming conventions
- Use `{{ include "drunk-app.fullname" . }}` for consistent naming
- Implement proper label selectors and annotations

#### Values Structure
```yaml
global:
  image: image-name
  tag: image-tag
  imagePullPolicy: Always
  imagePullSecret: secret-name

deployment:
  enabled: true
  replicaCount: 1
  ports:
    http: 8080
  strategy:
    type: RollingUpdate
    maxSurge: 1
    maxUnavailable: 0

service:
  enabled: true
  type: ClusterIP

ingress:
  enabled: false
  className: nginx
  hosts: []
```

#### Testing Strategy
1. **Template Tests**: Test each template can render correctly
2. **Value Tests**: Test different value combinations
3. **Conditional Tests**: Test enabled/disabled features
4. **Edge Cases**: Test boundary conditions and error scenarios

### Common Development Tasks

#### Creating a New Chart
1. Copy structure from existing chart (e.g., `drunk-app`)
2. Update `Chart.yaml` with new chart details
3. Modify `values.yaml` for chart-specific configuration
4. Update templates in `templates/` directory
5. Create comprehensive tests in `tests/` directory
6. Update documentation in `README.md`

#### Adding New Template
1. Create template file in `templates/` directory
2. Add corresponding test file in `tests/` directory
3. Test with multiple value scenarios
4. Ensure proper conditional rendering (if applicable)

#### Modifying Existing Template
1. Update template file
2. Update or add tests for new functionality
3. Run tests to ensure no regression
4. Test with different value combinations

#### Adding Chart Dependencies
1. Update `Chart.yaml` dependencies section:
```yaml
dependencies:
  - name: dependency-chart
    version: "^1.0.0"
    repository: "https://charts.example.com"
```
2. Run `helm dependency update`
3. Update tests to account for dependency templates
4. Document dependency requirements

### File Naming Conventions
- Chart names: lowercase, hyphen-separated (e.g., `drunk-app`)
- Template files: lowercase, descriptive (e.g., `deployment.yaml`)
- Test files: template-name + `.test.yaml` (e.g., `deployment.test.yaml`)
- Value files: `values.yaml`, `values.test.yaml`
- Script files: `build.sh`, `test.sh`, `verify.sh`

### Troubleshooting

#### Common Test Issues
- **Template not found**: Ensure template file exists and is named correctly
- **Value path errors**: Use `helm template` to check rendered YAML structure
- **Assertion failures**: Verify expected values match actual template output

#### Debug Commands
```bash
# Render templates to see output
helm template test-release ./

# Render with specific values
helm template test-release ./ --values values.test.yaml

# Lint chart for issues
helm lint ./

# Debug template rendering
helm template test-release ./ --debug
```

## Repository-Specific Guidelines

### drunk-app Chart
- Main application chart with comprehensive Kubernetes resources
- Supports multiple deployment patterns (Deployment, StatefulSet)
- Includes advanced features like HPA, Jobs, CronJobs, Ingress
- Uses drunk-lib for common template functions

### drunk-lib Chart
- Library chart providing shared templates and helpers
- Should not be deployed directly
- Contains reusable template functions and common patterns
- Changes here affect all dependent charts

### Chart Versioning
- Follow semantic versioning (MAJOR.MINOR.PATCH)
- Update `Chart.yaml` version when making changes
- Update `appVersion` when application version changes
- Document breaking changes in README.md

### Testing Coverage
- Every template should have corresponding tests
- Test both positive and negative scenarios
- Include edge cases and boundary conditions
- Verify all configurable values work correctly

This repository maintains high-quality Helm charts through comprehensive testing, clear documentation, and consistent development practices. Follow these guidelines when contributing to ensure compatibility and reliability.