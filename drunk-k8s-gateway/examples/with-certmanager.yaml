# Configuration with cert-manager Integration
# Creates Gateway with automatic TLS certificate management
#
# Prerequisites:
# 1. Install cert-manager first:
#    helm install cert-manager oci://quay.io/jetstack/charts/cert-manager \
#      --version v1.19.1 \
#      --namespace cert-manager \
#      --create-namespace \
#      --set crds.enabled=true
#
# 2. Then install this chart:
#    helm install gateway . -f examples/with-certmanager.yaml

gatewayClass:
  enabled: true
  name: nginx
  controllerName: gateway.nginx.org/nginx-gateway-controller

gateway:
  enabled: true
  name: shared-gateway
  gatewayClassName: nginx
  annotations:
    # Automatic certificate creation
    cert-manager.io/cluster-issuer: letsencrypt-prod

  listeners:
    - name: http
      protocol: HTTP
      port: 80
      hostname: "*"
      allowedRoutes:
        namespaces:
          from: All

    - name: https
      protocol: HTTPS
      port: 443
      hostname: "*"
      tls:
        mode: Terminate
        certificateRefs:
          - kind: Secret
            name: gateway-tls # cert-manager creates this
      allowedRoutes:
        namespaces:
          from: All

# Configure cert-manager ClusterIssuers
certManager:
  enabled: true
  clusterIssuers:
    # Production Let's Encrypt issuer
    - name: letsencrypt-prod
      email: admin@drunk.dev # Change this to your email
      server: https://acme-v02.api.letsencrypt.org/directory
      privateKeySecretRef:
        name: letsencrypt-prod-key
      solvers:
        # HTTP-01 challenge using Gateway
        - http01:
            gatewayHTTPRoute:
              parentRefs:
                - kind: Gateway
                  name: shared-gateway
                  namespace: default

    # Staging Let's Encrypt issuer for testing
    - name: letsencrypt-staging
      email: admin@drunk.dev # Change this to your email
      server: https://acme-staging-v02.api.letsencrypt.org/directory
      privateKeySecretRef:
        name: letsencrypt-staging-key
      solvers:
        - http01:
            gatewayHTTPRoute:
              parentRefs:
                - kind: Gateway
                  name: shared-gateway
                  namespace: default
