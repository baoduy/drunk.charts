# Local development override values for drunk-k8s-gateway
# Purpose: Quickly install Gateway API CRDs + a GatewayClass + a domain-specific Gateway
# on a local Kubernetes cluster (kind / minikube / k3d / k3s).
#
# Usage:
#   helm upgrade --install gateway ./drunk-k8s-gateway -f values.local.yaml
#
# After install (k3s/kind/minikube):
#   kubectl get gatewayclasses
#   kubectl get gateways -A
#   kubectl describe gateway drunk-dev-gateway -n default
#
# Notes:
# - This file ENABLES the vendored Traefik Helm subchart with Kubernetes Gateway API support
#   so you do NOT need to install the controller separately.
# - Traefik is lightweight and perfect for K3s local development.
# - For local clusters without a LoadBalancer, we configure NodePort for the data plane service.
# - cert-manager remains disabled by default (local TLS usually uses manual/self-signed secrets).

# Ensure CRDs are installed
gatewayAPI:
  enabled: true
  version: "v1.2.0"
  channel: "experimental" # Required for BackendTLSPolicy and other experimental features

# Enable vendored Traefik subchart with Gateway API support
traefik:
  enabled: true
  # Use specific Traefik version
  image:
    registry: docker.io
    repository: traefik
    tag: "v3.6.1"
  # Enable Kubernetes Gateway provider
  providers:
    kubernetesGateway:
      enabled: true
  # Disable default Gateway creation by Traefik (we manage our own)
  gateway:
    enabled: false
  # Service configuration - use LoadBalancer on K3s for automatic external IP
  service:
    type: LoadBalancer
  # Ports configuration - bind to host ports 80/443 directly
  ports:
    web:
      port: 80
      # Bind directly to node port 80 (requires privileged or hostNetwork)
      hostPort: 80
    websecure:
      port: 443
      # Bind directly to node port 443 (requires privileged or hostNetwork)
      hostPort: 443
  # Enable hostNetwork to allow binding to privileged ports 80/443
  hostNetwork: true
  # Use host network DNS policy
  dnsPolicy: ClusterFirstWithHostNet
  # Lightweight resource configuration for local development
  resources:
    requests:
      cpu: "50m"
      memory: "50Mi"
    limits:
      cpu: "200m"
      memory: "100Mi"

# Provide a single domain-specific Gateway for local testing.
# You can map dev.local or *.dev.local in /etc/hosts to the cluster ingress IP
# (e.g. minikube ip / kind ingress controller service).
# For TLS testing locally, create a secret manually or configure an ACME staging issuer.
domains:
  - name: "drunk-dev"
    enabled: true
    gatewayClassName: "traefik"
    # addresses:
    #   - type: IPAddress
    #     value: "10.96.86.116" # Gateway LoadBalancer IP (update /etc/hosts: 10.96.86.116 sample.dev.local)
    annotations: {}
    listeners:
      - name: http
        protocol: HTTP
        port: 80
        hostname: "*.dev.local"
        # allowedRoutes will be auto-generated from routeAccess below
      - name: https
        protocol: HTTPS
        port: 443
        hostname: "*.dev.local"
        # tls:
        #   mode: Terminate
        #   # certificateRefs must be specified when mode is Terminate
        #   # Create a TLS secret first, then add it here:
        #   certificateRefs:
        #     - kind: Secret
        #       name: drunk-dev-tls # Create this secret before deploying
        # allowedRoutes will be auto-generated from routeAccess below

# Allow routes from specific namespaces (List mode) in addition to the Gateway's own namespace
# Note: These namespaces must already exist and be labeled with the labelKey:labelValue
routeAccess:
  mode: "List"
  namespaces:
    - drunk-dev-apps
  labelKey: "gateway.drunk.charts/access"
  labelValue: "drunk-dev-gateway"

# Install cert-manager (dependency) but do not create ACME ClusterIssuers for local.
certManager:
  enabled: false
  installCRDs: true
  clusterIssuersEnabled: false
  clusterIssuers: []
